image: debian:bullseye

stages:
  - archive
  - release

variables:
  ZIP_NAME: "Panabyss-$CI_COMMIT_TAG.zip"

create_panabyss_archive:
  stage: archive
  script:
    - apt-get update && apt-get install -y zip
    - mkdir -p dist
    - zip -r "./dist/$ZIP_NAME" . -x "*.git*" "./dist/*"
    - ls -lh dist/
  only:
    - tags
  artifacts:
    name: "$ZIP_NAME"
    paths:
      - dist/
    expire_in: 1 week

release:
  image:
    name: registry.gitlab.com/gitlab-org/release-cli:latest
    entrypoint: [""]
  stage: release
  needs:
    - job: create_panabyss_archive
      artifacts: true
  script:
    - echo "Creating GitLab release with linked artifact"
  only:
    - tags
  release:
    tag_name: "$CI_COMMIT_TAG"
    name: "Release $CI_COMMIT_TAG"
    description: "Automated release for tag $CI_COMMIT_TAG"
    assets:
      links:
        - name: "$ZIP_NAME"
          url: "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_REF_NAME/raw/dist/$ZIP_NAME?job=create_panabyss_archive"