image: debian:bullseye

stages:
  - archive
  - release

variables:
  ZIP_NAME: "Panorama_graph-$CI_COMMIT_TAG.zip"

create_panorama_graph_archive:
  stage: archive
  script:
    - apt-get update && apt-get install -y zip
    - mkdir -p dist
    - cd Panorama_graph
    - zip -r "../dist/Panorama_graph-$CI_COMMIT_TAG.zip" . -x "*.git*" "../dist/*"
    - cd ..
  only:
    - tags
  artifacts:
    paths:
      - dist/$ZIP_NAME
    expire_in: never

release_graph:
  stage: release
  image: curlimages/curl:latest
  dependencies:
    - create_panorama_graph_archive
  before_script:
    - apk update && apk add --no-cache jq
  script:
    - |
      echo "Uploading archive to GitLab release..."

      # Upload the archive to GitLab project uploads
      UPLOAD_RESPONSE=$(curl --silent --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --upload-file "dist/$ZIP_NAME" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/uploads")

      # Extract the URL from the response
      ASSET_URL=$(echo "$UPLOAD_RESPONSE" | jq -r .url)

      # Create the release and attach the archive
      curl --request POST --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{
          \"name\": \"$CI_COMMIT_TAG\",
          \"tag_name\": \"$CI_COMMIT_TAG\",
          \"description\": \"Archive for $CI_COMMIT_TAG\",
          \"assets\": {
            \"links\": [
              {
                \"name\": \"$ZIP_NAME\",
                \"url\": \"$CI_PROJECT_URL$ASSET_URL\"
              }
            ]
          }
        }" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags